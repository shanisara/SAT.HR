@model SAT.HR.Models.PositionRateViewModel

@{
    ViewBag.Title = "PositionRate";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /*.bootstrap-select:not([class*=col-]):not([class*=form-control]):not(.input-group-btn) {
        width: 100px;
        margin-left: 13px;
        margin-top: -5px;
    }*/

    .card [class*=card-header-] .card-title a {
        color: #3C4858;
    }

        .card [class*=card-header-] .card-title a:hover {
            color: #fff;
        }
</style>

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header card-header-primary card-header-icon">
                    <div class="card-icon">
                        <i class="material-icons">group</i>
                    </div>
                    <h4 class="card-title">
                        <span> อัตรากำลังพล > <small> </small></span>
                        <div class="pull-right">
                            @Html.DropDownList("usertype", new SelectList((IEnumerable<SelectListItem>)ViewBag.UserType, "Value", "Text"), new { @class = "selectpicker", data_style = "select-with-transition" })
                        </div>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-10">
                            <div class="row col-md-12 form-horizontal m-b-10">
                                <input type="search" class="form-control search-tree" placeholder="ระบุคำค้นหา" />
                                <button type="button" class="col-sm-1 btn btn-primary btn-sm btn-search">ค้นหา</button>
                            </div>
                            <div id="organization"></div>
                        </div>
                        <div class="col-sm-2">
                            <div class="title-header pull-right">
                                @*<h5><span>ข้อมูลอัตรากำลังพล</span></h5>*@
                                @*@Html.Label("ประเภทอัตรากำลังพล: ", null, new { @class = "col-form-label" })*@
                                <button class="btn btn-primary btn-sm add-position" data-toggle="modal" id="btnAdd"><i class="material-icons">add</i> เพิ่มอัตรากำลังพล</button>
                            </div>
                            @*<div id="detail"></div>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Classic Modal -->
<div class="modal fade modal-large modal-position" role="dialog" aria-labelledby="modalPositionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><span>โยกย้ายอัตรากำลังพล</span></h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="material-icons">clear</i></button>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div class="detail-position"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-roundbtn-default btn-close" data-dismiss="modal">@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnClose)</button>&nbsp;&nbsp;
                <button type="button" class="btn btn-primary btn-save">@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnSave)</button>
            </div>
        </div>
    </div>
</div>
<!--  End Modal -->

@section Scripts {
    <link href="@Url.Content("~/Content/assets/js/jstree/themes/default/style.css")" rel="stylesheet" />
    <script src="@Url.Content("~/Content/assets/js/jstree/jstree.js")"></script>
    <script>

    $(document).ready(function () {

        //var windowHeight = window.innerHeight;
        //var treeHeight = 'height:' + (windowHeight - 230) + 'px';
        //$('.tree').attr("style", treeHeight);

        var jstree = {
            tree: null,
            initializeTree: function (usertype) {
                var $tree = $('#organization');
                jstree.tree = $tree.jstree({
                    'core': {
                        'strings': { 'Loading ...': 'กรุณารอสักครู่ ...' },
                        'data': {
                            'url': function (node) {
                                if (node.id === '#') {
                                    return 'GetRoot/' + usertype;
                                }
                                else {
                                    var div = null; var dep = null; var sec = null; var po = null;
                                    var parenttype = node.original.node_type;
                                    if (parenttype == 'div') {
                                        div = node.id;
                                    }
                                    else if (parenttype == 'dep') {
                                        div = (node.parents.length == 3) ? node.parents[0] : null;
                                        dep = node.id;
                                    }
                                    else if (parenttype == 'sec') {
                                        div = (node.parents.length == 4) ? node.parents[1] : null;
                                        dep = (node.parents.length == 4) ? node.parents[0] : null;
                                        sec = node.id;
                                    }
                                    else if (parenttype == 'pos') {
                                        div = (node.parents.length == 5) ? node.parents[2] : null;
                                        dep = (node.parents.length == 5) ? node.parents[1] : null;
                                        sec = (node.parents.length == 5) ? node.parents[0] : null;
                                        po = node.id;
                                    }
                                    else if (parenttype == 'user') {
                                        div = (node.parents.length == 6) ? node.parents[3] : null;
                                        dep = (node.parents.length == 6) ? node.parents[2] : null;
                                        sec = (node.parents.length == 6) ? node.parents[1] : null;
                                        po = (node.parents.length == 6) ? node.parents[0] : null;
                                    }
                                    return 'GetChildren/' + node.id + '?parenttype=' + parenttype + '&usertype=' + usertype + '&div=' + div + '&dep=' + dep + '&sec=' + sec + '&po=' + po;
                                }
                            },
                            'data': function (node, callback) {
                                return { 'id': node.id };
                            }
                        }
                    },
                    'types': {
                        "root": {
                            "icon": "glyphicon glyphicon-plus"
                        },
                        "child": {
                            "icon": "glyphicon glyphicon-leaf"
                        },
                        "default": {
                        }
                    },
                    'plugins': ['search', 'wholerow', 'sort', "types"]
                });

                $tree.on('changed.jstree', function (e, data) {
                    var usertype = $('#usertype').val();
                    if (data.node.original.node_type == 'user') {
                        var url = '@Url.Action("PositionRateDetail", "Employee")/' + data.node.id + "?type=" + usertype;
                        $.post(url, function (data) {
                            $(".detail-position").html(data);
                            $('.modal-position').modal('show');
                        });
                    }
                });


            },
            destroyTree: function (usertype) {
                debugger;
                if (jstree.tree != null) {
                    jstree.tree.jstree("destroy");
                }
                jstree.initializeTree(usertype);
            }
        }

        jstree.initializeTree(1);


        $(".btn-search").click(function (e) {
            e.preventDefault();
            $("#organization").jstree(true).search($(".search-tree").val());
        });


        $('.usertype').change(function () {
            var usertype = $('#usertype').val();
            jstree.destroyTree(usertype);
        });


        $(".add-position").click(function () {
            var usertype = $('#usertype').val();
            var url = '@Url.Action("PositionRateDetail", "Employee")/0' + "?type=" + usertype;
            $.post(url, function (data) {
                $(".detail-position").html(data);
                $('.modal-position').modal('show');
            });
        });


        $(".btn-save").click(function () {
            var $valid = $('.form-position').valid();
            if (!$valid) {
                //if ($("#DivID").val() == '') {
                //    $('#DivID-error').text(''); //กรุณาระบุฝ่าย
                //}
                //if ($("#DepID").val() == '') {
                //    $('#DepID-error').text(''); //กรุณาระบุกอง
                //}
                //if ($("#SecID").val() == '') {
                //    $('#SecID-error').text(''); //กรุณาระบุงาน
                //}
                //if ($("#PoID").val() == '') {
                //    $('#PoID-error').text(''); //กรุณาระบุตำแหน่ง
                //}
                return false;
            }
            else {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("SavePositionRate", "Employee")',
                    data: $(".form-position").serialize(),
                    dataType: 'json',
                    success: function (res) {
                        var msg = '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.SaveSucceed)'
                        if (res.ID != 0) {
                            msg = "เพิ่มอัตรากำลังพล " + res.ID + " เรียบร้อย";
                        }

                        if (res.MessageCode == null) {
                            swal({
                                title: "",
                                text: msg,
                                type: "success",
                                confirmButtonClass: "btn btn-primary",
                                confirmButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnClose)',
                                buttonsStyling: false
                            }).then(function () {
                                if (res.ID != 0) {
                                    var usertype = $('#usertype').val();
                                    jstree.destroyTree(usertype);
                                }
                                $('.modal-position').modal('hide');
                            });
                        }
                        else {
                            swal({
                                title: '',
                                text: res.MessageText,
                                type: 'error',
                                confirmButtonClass: "btn btn-primary",
                                confirmButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnYes)',
                                buttonsStyling: false
                            }).catch(swal.noop);
                        }
                    }
                });
            }
        });



    });

    </script>
}