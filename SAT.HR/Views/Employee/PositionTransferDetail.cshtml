@model SAT.HR.Models.PositionTransferViewModel

@{
    ViewBag.Title = "PositionTransferDetail";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .m-b-10 {
        margin-bottom: 10px;
    }

    .m-t-20 {
        margin-top: 20px;
    }

    .m-t-10 {
        margin-top: 20px;
    }

    .modal-dialog {
        max-width: 1100px;
        margin: 1.75rem auto;
    }

    .col-form-label {
        font-size: 14px;
    }

    .label-text {
        font-size: 14px;
        line-height: 2.679;
        color: #170cdb;
        font-weight: 100;
    }

    .table > thead > tr > th {
        vertical-align: text-top;
    }

    .table thead tr th {
        font-size: 15px;
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header card-header-icon card-header-primary">
                    <div class="card-icon">
                        <i class="material-icons">perm_identity</i>
                    </div>
                    <h4 class="card-title">
                        <span>โยกย้ายอัตรากำลังพล </span><small class="text-primary"></small>
                        <button type="button" class="btn btn-round pull-right btn-back">ย้อนกลับ</button>
                    </h4>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm(null, null, FormMethod.Post, new { @class = "formDetail" }))
                    {
                        @Html.HiddenFor(m => m.MopID)
                        @Html.HiddenFor(m => m.MopStatus)
                        @Html.HiddenFor(m => m.UserTID, new { Value = @ViewBag.UserTypeID })

                        <div class="form-horizontal">
                            
                            <div class="row">
                                @Html.Label("ปีบัญชี: ", null, new { @class = "col-sm-1 col-form-label" })
                                <div class="col-sm-1">
                                    @Html.TextBoxFor(m => m.MopYear, new { @class = "form-control" })
                                </div>
                                @Html.Label("เลขที่หนังสือคำสั่ง: ", null, new { @class = "col-sm-2 col-form-label" })
                                <div class="col-sm-2">
                                    @Html.TextBoxFor(m => m.MopBookCmd, new { @class = "form-control" })
                                </div>
                                @Html.Label("ประเภทพนักงาน: ", null, new { @class = "col-sm-2 col-form-label" })
                                <div class="col-sm-4">
                                    @Html.DropDownListFor(n => n.UserTID, new SelectList((IEnumerable<SelectListItem>)ViewBag.UserType, "Value", "Text"), "-- กรุณาเลือก --", new { @class = "form-control custom-select select-with-transition" })
                                </div>
                            </div>
                            <div class="row m-b-15">
                                @Html.Label("วันที่มีผล: ", null, new { @class = "col-sm-1 col-form-label" })
                                <div class="col-sm-2">
                                    @Html.TextBoxFor(m => m.MopDateEffText, new { @class = "form-control datepicker" })
                                </div>
                                @Html.Label("วันที่ลงคำสั่ง: ", null, new { @class = "col-sm-1 col-form-label" })
                                <div class="col-sm-2">
                                    @Html.TextBoxFor(m => m.MopDateCmdText, new { @class = "form-control datepicker" })
                                </div>
                                @Html.Label("ประเภทการโยกย้าย: ", null, new { @class = "col-sm-2 col-form-label" })
                                <div class="col-sm-4">
                                    @Html.DropDownListFor(n => n.MtID, new SelectList((IEnumerable<SelectListItem>)ViewBag.MoveType, "Value", "Text"), "-- กรุณาเลือก --", new { @class = "form-control custom-select select-with-transition" })
                                </div>
                            </div>
                            <div class="row">
                                @Html.Label("ผู้ลงนาม: ", null, new { @class = "col-sm-1 col-form-label" })
                                <div class="col-sm-5">
                                    @Html.TextBoxFor(m => m.MopSignatory, new { @class = "form-control" })
                                </div>
                                @Html.Label("ไฟล์หนังสือคำสั่ง: ", null, new { @class = "col-sm-2 col-form-label" })
                                <div class="col-sm-4">
                                    <input id="fileUpload" name="fileUpload" type="file" class="form-control file">
                                    @*@Html.TextBoxFor(m => m.MopPathFile, new { @class = "form-control"  })*@
                                </div>
                            </div>
                            <div class="row m-b-10"></div>
                        </div>
                        <div class="toolbar pull-right">
                            <button type="button" class="btn btn-primary btn-sm btn-new" data-toggle="modal"><i class="material-icons">add</i> เพิ่มรายการ</button>
                        </div>
                        <div class="position-transfer">
                            <table id="tb-detail" data-url="@Url.Content("~/Employee/PositionTransferDetail")" class="table table-striped table-no-bordered table-hover" cellspacing="0" style="width:100%">
                                <thead class="text-primary">
                                    <tr>
                                        <th style="width:4%" class="disabled-sorting">ลำดับ</th>
                                        <th style="width:15%">ชื่อ-นามสกุล</th>
                                        <th style="width:16%">ตำแหน่งเก่า</th>
                                        <th style="width:16%">ตำแหน่งใหม่</th>
                                        <th style="width:30%">รักษาการแทน</th>
                                        <th style="width:9%">หมายเหตุ</th>
                                        <th style="width:10%" class="disabled-sorting text-right">ปฏิบัติการ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    }
                </div>
                <div class="row m-b-10">
                    <div class="ml-auto mr-auto">
                        <button type="button" class="btn btn-round btn-back">ย้อนกลับ</button>
                        <button type="button" class="btn btn-round btn-primary btn-save">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Classic Modal -->
<div class="modal fade modal-large modal-transfer" role="dialog" aria-labelledby="modalTransferLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><span>โยกย้ายอัตรากำลังพล</span></h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="material-icons">clear</i></button>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div class="detail-transfer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-roundbtn-default btn-close" data-dismiss="modal">@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnClose)</button>&nbsp;&nbsp;
                <button type="button" class="btn btn-primary btn-add">เพิ่มลงรายการ</button>
            </div>
        </div>
    </div>
</div>
<!--  End Modal -->

@section Scripts {
    <script>
    $(document).ready(function () {

        $('.datepicker').datetimepicker({
            format: 'DD/MM/YYYY',
            icons: {
                time: "fa fa-clock-o",
                date: "fa fa-calendar",
                up: "fa fa-chevron-up",
                down: "fa fa-chevron-down",
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove'
            }
        });

        @*var dataTable = {
            table: null,
            initializeDataTable: function () {
                var id = $("#MopID").val();

                $table = $('#tb-detail');

                dataTable.table = $table.DataTable({
                    "proccessing": true,
                    "serverSide": true,
                    paging: false,
                    bFilter: false,
                    ordering: false,
                    searching: true,
                    dom: 't',
                    language: { zeroRecords: "ไม่พบข้อมูล" },
                    ajax: {
                        url: '@Url.Action("PositionTransferDetail", "Employee")/' + id,
                        type: "POST",
                    },
                    "columns": [
                        { "data": "RowNumber", "orderable": false, "searchable": false },
                        { "data": "UserName", "orderable": true },
                        { "data": "PoNameNew", "orderable": true },
                        { "data": "PoNameOld", "orderable": true },
                        { "data": "AgentPo", "orderable": true },
                        { "data": "MovRemark", "orderable": true },
                    ],
                    "columnDefs": [
                        {
                            "render": function (data, type, row) {
                                var inner = '<div class="td-actions text-right">' +
                                                '<button title="ลบ" type="button" rel="tooltip" class="btn btn-round btn-danger delete" data-id="' + row.UserID + '"><i class="material-icons">close</i></button>' +
                                            '</div>';
                                return inner;
                            }, "targets": 6
                        },
                    ]
                });
            },
            getData: function () {
                if (dataTable.table == null)
                    dataTable.initializeDataTable();
                else
                    dataTable.table.ajax.reload();
            }
        }

        dataTable.getData();*@

        var runningIndex = function () {
            var index = 1;
            $('#tb-detail tbody tr td:first-child').each(function () {
                $(this).html(index);
                index++;
            });
        }

        $(".btn-back").click(function () {
            var url = '@Url.Action("PositionTransfer", "Employee")';
            window.location.href = url;
        });

        $(".btn-new").click(function () {
            var type = $("#UserTID").val()
            var url = '@Url.Action("PositionTransferDetailByID", "Employee")';
            $.post(url, { id: 0, type: type }, function (data) {
                $(".detail-transfer").html(data);
                $('.modal-transfer').modal('show');
            });
        });

        $(".btn-add").click(function () {
            var userid = $("#UserID").val();
            var username = $("#UserID option:selected").text();
            var curpoid = $('#CurPoID').val();
            var curponame = $(".user-po").text();
            var movpoid = $('#MovPoID').text();
            var movponame = $("#MovPoID option:selected").text();
            var agenttypeid = $('#AgentPoTID').val();
            var agenttype = $("#AgentPoTID option:selected").text();
            var agentpoid = $('#AgentPoID').val();
            var agentponame = $("#AgentPoID option:selected").text();
            var agentbelong = $('.agent-belong').text();
            var remark = $("#MovRemark").val();

            var agentpo = '';
            if (agentpoid != '')
                agentpo = agenttype + ": " + agentponame + "<div style='font-size: 12px; color: #0000ff; border-bottom: #c0c0c0 0px dotted; margin-bottom: 5px;'><i class='fa fa-home'></i>" + agentbelong + "</div>";

            var data = "<tr data-userid='" + userid + "' data-curpoid='" + curpoid + "' data-movpoid='" + movpoid + "' data-agentpotid= '" + agenttypeid + "' data-agentpoid='" + agentpoid + "' data-remark='" + remark + "'>" +
                "<td></td>" +
                "<td>" + username + "</td>" +
                "<td>" + curponame + "</td>" +
                "<td>" + movponame + "</td>" +
                "<td>" + agentpo + "</td>" +
                "<td>" + remark + "</td> " +
                "<td><div class='td-actions text-right'><button title='ลบ' type='button' rel='tooltip' class='btn btn-round btn-danger btn-delete' data-id='" + userid + "'><i class='material-icons'>close</i></button></td></div>" +
                "</tr>";
            $("#tb-detail tbody").append(data);

            runningIndex();

            $('.modal-transfer').modal('hide');
        });

        $(".btn-save").click(function () {
            var listName = "ListDetail";
            var qtd = 0;
            $("#tb-detail tbody tr").each(function () {
                var userid = $(this).data("userid");
                var curpoid = $(this).data("curpoid");
                var movpoid = $(this).data("movpoid");
                var agentpotid = $(this).data("agentpotid");
                var agentpoid = $(this).data("agentpoid");
                var remark = $(this).data("remark");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].UserID' value= '" + userid + "' > ");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].CurPoID' value= '" + curpoid + "' > ");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].MovPoID' value= '" + movpoid + "' > ");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].PoTID' value= '" + agentpotid + "' > ");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].AgentID' value= '" + agentpoid + "' > ");
                $(".formDetail").prepend("<input type='hidden' name= '" + listName + "[" + qtd + "].MovRemark' value= '" + remark + "' > ");
                qtd += 1;
            });

            var form = $('.formDetail')[0];
            var data = new FormData(form);
            data.append(".fileUpload", fileUpload);

            $.ajax({
                type: 'POST',
                url: '@Url.Action("SavePositionTransfer", "Employee")',
                data: data,
                dataType: 'json',
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.MessageCode == null) {
                        swal({
                            title: "",
                            text: "@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.SaveSucceed)",
                            type: "success",
                            confirmButtonClass: "btn btn-primary",
                            confirmButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnClose)',
                            buttonsStyling: false,
                        }).then(function () {
                            $('#modalDetail').modal('hide');
                        });
                    }
                    else {
                        swal({
                            title: '',
                            text: res.MessageText,
                            type: 'error',
                            confirmButtonClass: "btn btn-primary",
                            confirmButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnYes)',
                            buttonsStyling: false
                        }).catch(swal.noop);
                    }
                }
            });
        });

        $("#tb-detail").on('click', '.btn-delete', function () {
            var itemDelete = $(this);
            swal({
                title: '',
                text: "@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.ConfirmDelete)",
                type: 'question',
                showCancelButton: true,
                confirmButtonClass: 'btn btn-success',
                cancelButtonClass: 'btn btn-danger',
                confirmButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnYes)',
                cancelButtonText: '@MvcHtmlString.Create(SAT.HR.Resources.ResourceSAT.btnNo)',
                buttonsStyling: false
            }).then(function () {
                itemDelete.parent().parent().parent().remove();
                runningIndex();
            });
        });

    });
    </script>
}
